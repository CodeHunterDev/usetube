"use strict";var __awaiter=this&&this.__awaiter||function(e,t,i,o){return new(i||(i=Promise))((function(n,l){function d(e){try{r(o.next(e))}catch(e){l(e)}}function a(e){try{r(o.throw(e))}catch(e){l(e)}}function r(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(d,a)}r((o=o.apply(e,t||[])).next())}))};const axios_1=require("axios"),moment=require("moment"),headers={headers:{"Access-Control-Allow-Origin":"*","x-youtube-client-name":1,"x-youtube-client-version":"2.20200911.04.00","User-Agent":"Mozilla/5.0 (Linux; Android 5.0; SM-G900P Build/LRX21T) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/67.0.3396.87 Mobile Safari/537.36"}},headersAJAX={headers:{"Access-Control-Allow-Origin":"*","User-Agent":"hellobiczes","x-youtube-client-name":1,"x-youtube-client-version":"2.20200731.02.01"}},mobileRegex=/var\ ytInitialData\ \=\ \'(.*)\'\;<\/script>/,dateRegex=/publishDate":"(.*)","ownerChannelName/;function decodeHex(e){return e.replace(/\\x22/g,'"').replace(/\\x7b/g,"{").replace(/\\x7d/g,"}").replace(/\\x5b/g,"[").replace(/\\x5d/g,"]").replace(/\\x3b/g,";").replace(/\\x3d/g,"=").replace(/\\x27/g,"'").replace(/\\\\/g,"doubleAntiSlash").replace(/\\/g,"").replace(/doubleAntiSlash/g,"\\")}function wait(){let e=Math.floor(300*Math.random()),t=(new Date).getTime(),i=t;for(;i<t+e;)i=(new Date).getTime()}function cleanTitle(e){return e=e.replace(/\[[^)]*\]/,""),["(full album)","(official ep)","(official video)","(video official)","(radio edit)","(DEEP MEDi Musik)","(Original Mix)","(Official Music Video)"].forEach((t=>{e=(e=(e=e.replace(new RegExp(t,"ig"),"")).replace("()","")).replace(/\[(.*)\]/,"")})),e}function formatYoutubeCount(e){const t=null==e?void 0:e.includes("M"),i=null==e?void 0:e.includes("k");let o=null==e?void 0:e.replace(/[^0-9,.]/g,"").replace(",",".");return t?o*=1e6:i&&(o*=1e3),parseInt(o)||0}function getVideoDate(e){var t;return __awaiter(this,void 0,void 0,(function*(){try{const i=(yield axios_1.default.get("https://m.youtube.com/watch?v="+e,headers)).data;let o=(null===(t=dateRegex.exec(i))||void 0===t?void 0:t[1])||"{}";return o+=" "+Math.floor(24*Math.random())+"-"+Math.floor(60*Math.random())+"-"+Math.floor(60*Math.random()),moment(o,"YYYY-MM-DD H-m-s").toDate()}catch(e){}}))}function getVideoDesc(e){var t,i,o,n,l,d,a,r,s,u;return __awaiter(this,void 0,void 0,(function*(){try{const c=(yield axios_1.default.get("https://m.youtube.com/watch?v="+encodeURI(e),headers)).data,v=(null===(t=mobileRegex.exec(c))||void 0===t?void 0:t[1])||"{}",h=JSON.parse(decodeHex(v));return(null===(u=null===(s=null===(r=null===(a=null===(d=null===(l=null===(n=null===(o=null===(i=h.contents)||void 0===i?void 0:i.singleColumnWatchNextResults)||void 0===o?void 0:o.results)||void 0===n?void 0:n.results)||void 0===l?void 0:l.contents[1])||void 0===d?void 0:d.itemSectionRenderer)||void 0===a?void 0:a.contents[0])||void 0===r?void 0:r.slimVideoMetadataRenderer)||void 0===s?void 0:s.description)||void 0===u?void 0:u.runs)||""}catch(e){}}))}function getChannelDesc(e){var t,i,o;return __awaiter(this,void 0,void 0,(function*(){try{const n=(yield axios_1.default.get("https://m.youtube.com/channel/"+encodeURI(e)+"/videos",headers)).data,l=(null===(t=mobileRegex.exec(n))||void 0===t?void 0:t[1])||"{}",d=JSON.parse(decodeHex(l));return(null===(o=null===(i=d.metadata)||void 0===i?void 0:i.channelMetadataRenderer)||void 0===o?void 0:o.description)||""}catch(e){}}))}function searchVideo(e,t){var i,o,n,l,d,a,r,s,u,c,v;return __awaiter(this,void 0,void 0,(function*(){try{let h=[],g=[],m="";if(t){let e=(yield axios_1.default.get("https://youtube.com/browse_ajax?ctoken="+t,headersAJAX)).data;h=(null===(a=null===(d=e[1].response.continuationContents)||void 0===d?void 0:d.gridContinuation)||void 0===a?void 0:a.items)||"",t=(null===(v=null===(c=null===(u=null===(s=null===(r=e[1].response.continuationContents)||void 0===r?void 0:r.gridContinuation)||void 0===s?void 0:s.continuations)||void 0===u?void 0:u[0])||void 0===c?void 0:c.nextContinuationData)||void 0===v?void 0:v.continuation)||""}else{let d=(yield axios_1.default.get("https://m.youtube.com/results?sp=EgIQAQ%253D%253D&videoEmbeddable=true&search_query="+encodeURI(e),headers)).data,a=(null===(i=mobileRegex.exec(d))||void 0===i?void 0:i[1])||"{}",r=JSON.parse(decodeHex(a)).contents.sectionListRenderer;h=r.contents[0].itemSectionRenderer.contents,t=(null===(l=null===(n=null===(o=r.continuations)||void 0===o?void 0:o[0])||void 0===n?void 0:n.reloadContinuationData)||void 0===l?void 0:l.continuation)||""}for(let e=0;e<h.length;e++){let t=yield formatVideo(h[e],!0);"didyoumean"===t.id?m=t.title:g.push(t)}return{tracks:g,didyoumean:m,token:t}}catch(e){}}))}function searchChannel(e,t){var i,o,n,l,d,a,r,s,u,c,v,h,g,m,p,f,x,y;return __awaiter(this,void 0,void 0,(function*(){try{let b=[],R=[],C="";if(t){let e=(yield axios_1.default.get("https://youtube.com/browse_ajax?ctoken="+t,headersAJAX)).data;b=(null===(u=null===(s=e[1].response.continuationContents)||void 0===s?void 0:s.gridContinuation)||void 0===u?void 0:u.items)||"",t=(null===(m=null===(g=null===(h=null===(v=null===(c=e[1].response.continuationContents)||void 0===c?void 0:c.gridContinuation)||void 0===v?void 0:v.continuations)||void 0===h?void 0:h[0])||void 0===g?void 0:g.nextContinuationData)||void 0===m?void 0:m.continuation)||""}else{const s=(yield axios_1.default.get("https://m.youtube.com/results?sp=CAASAhAC&search_query="+encodeURI(e),headers)).data,u=(null===(i=mobileRegex.exec(s))||void 0===i?void 0:i[1])||"{}",c=JSON.parse(decodeHex(u));b=null===(l=null===(n=null===(o=c.contents.sectionListRenderer)||void 0===o?void 0:o.contents[0])||void 0===n?void 0:n.itemSectionRenderer)||void 0===l?void 0:l.contents,t=(null===(r=null===(a=null===(d=c.continuations)||void 0===d?void 0:d[0])||void 0===a?void 0:a.reloadContinuationData)||void 0===r?void 0:r.continuation)||""}for(let e=0;e<b.length;e++)if(b[e].compactChannelRenderer){const t=b[e].compactChannelRenderer;let i=(null===(p=t.thumbnail)||void 0===p?void 0:p.thumbnails[0].url)||"",o=(null===(f=t.thumbnail)||void 0===f?void 0:f.thumbnails[1].url)||"";i=i.startsWith("//")?"https:"+i:i,o=o.startsWith("//")?"https:"+o:o;const n=formatYoutubeCount(null===(x=t.subscriberCountText)||void 0===x?void 0:x.runs[0].text),l=formatYoutubeCount(null===(y=t.videoCountText)||void 0===y?void 0:y.runs[0].text);R.push({name:t.title.runs[0].text,channel_id:t.channelId,nb_videos:l,nb_subscriber:n,official:!!t.ownerBadges,channel_avatar_small:i,channel_avatar_medium:o})}else if(b[e].didYouMeanRenderer||b[e].showingResultsForRenderer){let t;t=b[e].didYouMeanRenderer?b[e].didYouMeanRenderer:b[e].showingResultsForRenderer,C=t.correctedQuery.runs[0].text}return{channels:R,didyoumean:C,token:t}}catch(e){}}))}function getChannelVideos(e,t){var i,o,n,l,d,a,r,s,u,c,v,h,g,m,p,f,x,y,b,R;return __awaiter(this,void 0,void 0,(function*(){try{const C=(yield axios_1.default.get("https://m.youtube.com/channel/"+e+"/videos",headers)).data,_=(null===(i=mobileRegex.exec(C))||void 0===i?void 0:i[1])||"{}",V=JSON.parse(decodeHex(_)),w=null===(s=null===(r=null===(a=null===(d=null===(l=null===(n=null===(o=V.contents)||void 0===o?void 0:o.singleColumnBrowseResultsRenderer)||void 0===n?void 0:n.tabs[1])||void 0===l?void 0:l.tabRenderer)||void 0===d?void 0:d.content)||void 0===a?void 0:a.sectionListRenderer)||void 0===r?void 0:r.contents[0])||void 0===s?void 0:s.itemSectionRenderer;let D=(null===(v=null===(c=null===(u=w.continuations)||void 0===u?void 0:u[0])||void 0===c?void 0:c.nextContinuationData)||void 0===v?void 0:v.continuation)||"",A=[];for(let e=0;e<w.contents.length;e++){let i=yield formatVideo(w.contents[e]);if(moment(i.publishedAt).isBefore(t)&&t)return A;A.push(i)}for(;""!==D;)try{wait();let e=(yield axios_1.default.get("https://youtube.com/browse_ajax?ctoken="+D,headersAJAX)).data,i=(null===(p=null===(m=null===(g=null===(h=e[1])||void 0===h?void 0:h.response)||void 0===g?void 0:g.continuationContents)||void 0===m?void 0:m.gridContinuation)||void 0===p?void 0:p.items)||"";D=(null===(R=null===(b=null===(y=null===(x=null===(f=e[1].response.continuationContents)||void 0===f?void 0:f.gridContinuation)||void 0===x?void 0:x.continuations)||void 0===y?void 0:y[0])||void 0===b?void 0:b.nextContinuationData)||void 0===R?void 0:R.continuation)||"";for(let e=0;e<i.length;e++){let o=yield formatVideo(i[e]);if(moment(o.publishedAt).isBefore(t)&&t)return A;A.push(o)}}catch(e){console.log("getChannelVideos failed"),console.log(e),D=""}return A}catch(t){console.log("cannot get channel videos for id: "+e+", try again")}}))}function getPlaylistVideos(e,t){var i,o,n,l,d,a,r,s,u,c,v,h,g;return __awaiter(this,void 0,void 0,(function*(){try{const m=(yield axios_1.default.get("https://m.youtube.com/playlist?list="+e,headers)).data,p=(null===(i=mobileRegex.exec(m))||void 0===i?void 0:i[1])||"{}",f=JSON.parse(decodeHex(p)),x=(null===(c=null===(u=null===(s=null===(r=null===(a=null===(d=null===(l=null===(n=null===(o=f.contents)||void 0===o?void 0:o.singleColumnBrowseResultsRenderer)||void 0===n?void 0:n.tabs[0])||void 0===l?void 0:l.tabRenderer)||void 0===d?void 0:d.content)||void 0===a?void 0:a.sectionListRenderer)||void 0===r?void 0:r.contents[0])||void 0===s?void 0:s.itemSectionRenderer)||void 0===u?void 0:u.contents[0])||void 0===c?void 0:c.playlistVideoListRenderer)||"";let y=(null===(v=x.continuations[0])||void 0===v?void 0:v.nextContinuationData.continuation)||"",b=[];for(let e=0;e<x.contents.length;e++)b.push(yield formatVideo(x.contents[e]),t);for(;""!==y;)try{wait();const e=(yield axios_1.default.get("https://m.youtube.com/playlist?ctoken="+y,headers)).data;let i=(null===(h=mobileRegex.exec(e))||void 0===h?void 0:h[1])||"{}",o=JSON.parse(decodeHex(i)).continuationContents.playlistVideoListContinuation,n=o.contents;y=o.continuations?null===(g=o.continuations[0])||void 0===g?void 0:g.nextContinuationData.continuation:"";for(let e=0;e<n.length;e++)b.push(yield formatVideo(n[e]),t)}catch(e){console.log("getPlaylistVideos failed"),console.log(e),y=""}return b}catch(t){console.log("cannot get playlist "+e+", try again"),console.log(t)}}))}function getVideosFromDesc(e){return __awaiter(this,void 0,void 0,(function*(){try{let t=(yield getVideoDesc(e)).pop().text.split("\n").filter(Boolean),i=[];t=t.filter((e=>!e.includes("00:00"))),t=t.filter((e=>!e.startsWith(" ")));for(let e=0;e<t.length;e++){let o=cleanTitle(t[e]).replace(/[0-9]?[0-9]?:[0-9]?[0-9]?/,""),n=o.split("-")[1].trim(),l=o.split("-")[0].trim(),d=yield searchVideo(n+" "+l);e:for(let e=0;e<d.tracks.length;e++){let t=d.tracks[e],o=t.original_title.toLowerCase();if(o.includes(l.split(" ")[0].toLowerCase())&&o.includes(n.split(" ")[0].toLowerCase())){t.publishedAt=yield getVideoDate(t.id),t.title=n,t.artist=l,i.push(t);break e}}}return i}catch(e){console.log(e)}}))}function formatVideo(e,t){var i,o,n,l,d;return __awaiter(this,void 0,void 0,(function*(){try{if(e.compactVideoRenderer||e.gridVideoRenderer||e.playlistVideoRenderer){e.compactVideoRenderer?e=e.compactVideoRenderer:e.gridVideoRenderer?e=e.gridVideoRenderer:e.playlistVideoRenderer&&(e=e.playlistVideoRenderer);let a=e.videoId,r=0;if(e.title.simpleText?e.title=e.title.simpleText:e.title.runs[0].text?e.title=e.title.runs[0].text:e.title="",e.original_title=e.title,1===e.title.split("-").length)e.artist="";else{let t=e.original_title.match(/([^,]*)-(.*)/);e.artist=t[1],e.title=t[2]}r=e.lengthText?e.lengthText.runs[0].text.split(":"):(null===(o=null===(i=e.thumbnailOverlays[0])||void 0===i?void 0:i.thumbnailOverlayTimeStatusRenderer)||void 0===o?void 0:o.text.simpleText)?(null===(l=null===(n=e.thumbnailOverlays[0])||void 0===n?void 0:n.thumbnailOverlayTimeStatusRenderer)||void 0===l?void 0:l.text.simpleText.split(":"))||"":[0,0];let s=60*parseInt(r[0]),u=parseInt(r[1]),c=t?(null===(d=e.publishedTimeText)||void 0===d?void 0:d.runs[0].text)||"":yield getVideoDate(a);return{id:a,original_title:e.original_title.trim(),title:e.title.trim(),artist:e.artist.trim(),duration:s+u,publishedAt:c}}if(e.didYouMeanRenderer||e.showingResultsForRenderer)return{id:"didyoumean",title:(e=e.didYouMeanRenderer?e.didYouMeanRenderer:e.showingResultsForRenderer).correctedQuery.runs[0].text,artist:"",duration:0,publishedAt:""}}catch(e){console.log("format video failed")}}))}module.exports={getVideoDate:getVideoDate,getVideoDesc:getVideoDesc,getChannelDesc:getChannelDesc,searchVideo:searchVideo,searchChannel:searchChannel,getChannelVideos:getChannelVideos,getPlaylistVideos:getPlaylistVideos,getVideosFromDesc:getVideosFromDesc};
