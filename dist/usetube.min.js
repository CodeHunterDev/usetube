"use strict";var __awaiter=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(o,l){function d(e){try{r(i.next(e))}catch(e){l(e)}}function a(e){try{r(i.throw(e))}catch(e){l(e)}}function r(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(d,a)}r((i=i.apply(e,t||[])).next())}))};const axios_1=require("axios"),moment=require("moment"),headers={headers:{"Access-Control-Allow-Origin":"*","x-youtube-client-name":1,"x-youtube-client-version":"2.20200911.04.00","User-Agent":"Mozilla/5.0 (Linux; Android 5.0; SM-G900P Build/LRX21T) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/67.0.3396.87 Mobile Safari/537.36"}},headersAJAX={headers:{"Access-Control-Allow-Origin":"*","User-Agent":"hellobiczes","x-youtube-client-name":1,"x-youtube-client-version":"2.20200731.02.01"}},mobileRegex=/var\ ytInitialData\ \=\ \'(.*)\'\;<\/script>/,dateRegex=/publishDate":"(.*)","ownerChannelName/;function decodeHex(e){return e.replace(/\\x22/g,'"').replace(/\\x7b/g,"{").replace(/\\x7d/g,"}").replace(/\\x5b/g,"[").replace(/\\x5d/g,"]").replace(/\\x3b/g,";").replace(/\\x3d/g,"=").replace(/\\x27/g,"'").replace(/\\\\/g,"doubleAntiSlash").replace(/\\/g,"").replace(/doubleAntiSlash/g,"\\")}function wait(e){for(var t=(new Date).getTime(),n=t;n<t+e;)n=(new Date).getTime()}function formatYoutubeCount(e){const t=null==e?void 0:e.includes("M"),n=null==e?void 0:e.includes("k");let i=null==e?void 0:e.replace(/[^0-9,.]/g,"").replace(",",".");return t?i*=1e6:n&&(i*=1e3),parseInt(i)||0}function getVideoDate(e){var t;return __awaiter(this,void 0,void 0,(function*(){try{const n=(yield axios_1.default.get("https://m.youtube.com/watch?v="+e,headers)).data;let i=(null===(t=dateRegex.exec(n))||void 0===t?void 0:t[1])||"{}";return i+=" "+Math.floor(24*Math.random())+"-"+Math.floor(60*Math.random())+"-"+Math.floor(60*Math.random()),moment(i,"YYYY-MM-DD H-m-s").toDate()}catch(t){getVideoDate(e)}}))}function getChannelDesc(e){var t,n,i;return __awaiter(this,void 0,void 0,(function*(){try{const o=(yield axios_1.default.get("https://m.youtube.com/channel/"+encodeURI(e)+"/videos",headers)).data,l=(null===(t=mobileRegex.exec(o))||void 0===t?void 0:t[1])||"{}",d=JSON.parse(decodeHex(l));return(null===(i=null===(n=d.metadata)||void 0===n?void 0:n.channelMetadataRenderer)||void 0===i?void 0:i.description)||""}catch(e){}}))}function searchVideo(e,t){var n,i,o,l,d,a,r,u,s,c,v;return __awaiter(this,void 0,void 0,(function*(){try{let h=[],m=[],g="";if(t){let e=(yield axios_1.default.get("https://youtube.com/browse_ajax?ctoken="+t,headersAJAX)).data;h=(null===(a=null===(d=e[1].response.continuationContents)||void 0===d?void 0:d.gridContinuation)||void 0===a?void 0:a.items)||"",t=(null===(v=null===(c=null===(s=null===(u=null===(r=e[1].response.continuationContents)||void 0===r?void 0:r.gridContinuation)||void 0===u?void 0:u.continuations)||void 0===s?void 0:s[0])||void 0===c?void 0:c.nextContinuationData)||void 0===v?void 0:v.continuation)||""}else{let d=(yield axios_1.default.get("https://m.youtube.com/results?sp=EgIQAQ%253D%253D&videoEmbeddable=true&search_query="+e,headers)).data,a=(null===(n=mobileRegex.exec(d))||void 0===n?void 0:n[1])||"{}",r=JSON.parse(decodeHex(a)).contents.sectionListRenderer;h=r.contents[0].itemSectionRenderer.contents,t=(null===(l=null===(o=null===(i=r.continuations)||void 0===i?void 0:i[0])||void 0===o?void 0:o.reloadContinuationData)||void 0===l?void 0:l.continuation)||""}for(let e=0;e<h.length;e++){let t=yield formatVideo(h[e],!0);"didyoumean"===t.id?g=t.title:m.push(t)}return{tracks:m,didyoumean:g,token:t}}catch(e){}}))}function searchChannel(e,t){var n,i,o,l,d,a,r,u,s,c,v,h,m,g,x,p,f,b;return __awaiter(this,void 0,void 0,(function*(){try{let y=[],R=[],C="";if(t){let e=(yield axios_1.default.get("https://youtube.com/browse_ajax?ctoken="+t,headersAJAX)).data;y=(null===(s=null===(u=e[1].response.continuationContents)||void 0===u?void 0:u.gridContinuation)||void 0===s?void 0:s.items)||"",t=(null===(g=null===(m=null===(h=null===(v=null===(c=e[1].response.continuationContents)||void 0===c?void 0:c.gridContinuation)||void 0===v?void 0:v.continuations)||void 0===h?void 0:h[0])||void 0===m?void 0:m.nextContinuationData)||void 0===g?void 0:g.continuation)||""}else{const u=(yield axios_1.default.get("https://m.youtube.com/results?sp=CAASAhAC&search_query="+encodeURI(e),headers)).data,s=(null===(n=mobileRegex.exec(u))||void 0===n?void 0:n[1])||"{}",c=JSON.parse(decodeHex(s));y=null===(l=null===(o=null===(i=c.contents.sectionListRenderer)||void 0===i?void 0:i.contents[0])||void 0===o?void 0:o.itemSectionRenderer)||void 0===l?void 0:l.contents,t=(null===(r=null===(a=null===(d=c.continuations)||void 0===d?void 0:d[0])||void 0===a?void 0:a.reloadContinuationData)||void 0===r?void 0:r.continuation)||""}for(let e=0;e<y.length;e++)if(y[e].compactChannelRenderer){const t=y[e].compactChannelRenderer;let n=(null===(x=t.thumbnail)||void 0===x?void 0:x.thumbnails[0].url)||"",i=(null===(p=t.thumbnail)||void 0===p?void 0:p.thumbnails[1].url)||"";n=n.startsWith("//")?"https:"+n:n,i=i.startsWith("//")?"https:"+i:i;const o=formatYoutubeCount(null===(f=t.subscriberCountText)||void 0===f?void 0:f.runs[0].text),l=formatYoutubeCount(null===(b=t.videoCountText)||void 0===b?void 0:b.runs[0].text);R.push({name:t.title.runs[0].text,channel_id:t.channelId,nb_videos:l,nb_subscriber:o,official:!!t.ownerBadges,channel_avatar_small:n,channel_avatar_medium:i})}else if(y[e].didYouMeanRenderer||y[e].showingResultsForRenderer){let t;t=y[e].didYouMeanRenderer?y[e].didYouMeanRenderer:y[e].showingResultsForRenderer,C=t.correctedQuery.runs[0].text}return{channels:R,didyoumean:C,token:t}}catch(e){}}))}function getChannelVideos(e,t){var n,i,o,l,d,a,r,u,s,c,v,h,m,g,x,p,f,b,y,R;return __awaiter(this,void 0,void 0,(function*(){try{const C=(yield axios_1.default.get("https://m.youtube.com/channel/"+e+"/videos",headers)).data,_=(null===(n=mobileRegex.exec(C))||void 0===n?void 0:n[1])||"{}",w=JSON.parse(decodeHex(_)),A=null===(u=null===(r=null===(a=null===(d=null===(l=null===(o=null===(i=w.contents)||void 0===i?void 0:i.singleColumnBrowseResultsRenderer)||void 0===o?void 0:o.tabs[1])||void 0===l?void 0:l.tabRenderer)||void 0===d?void 0:d.content)||void 0===a?void 0:a.sectionListRenderer)||void 0===r?void 0:r.contents[0])||void 0===u?void 0:u.itemSectionRenderer;let D=(null===(v=null===(c=null===(s=A.continuations)||void 0===s?void 0:s[0])||void 0===c?void 0:c.nextContinuationData)||void 0===v?void 0:v.continuation)||"",M=[];for(let e=0;e<A.contents.length;e++){let n=yield formatVideo(A.contents[e]);if(moment(n.publishedAt).isBefore(t)&&t)return M;M.push(n)}for(;""!==D;)try{wait(Math.floor(300*Math.random()));let e=(yield axios_1.default.get("https://youtube.com/browse_ajax?ctoken="+D,headersAJAX)).data,n=(null===(x=null===(g=null===(m=null===(h=e[1])||void 0===h?void 0:h.response)||void 0===m?void 0:m.continuationContents)||void 0===g?void 0:g.gridContinuation)||void 0===x?void 0:x.items)||"";D=(null===(R=null===(y=null===(b=null===(f=null===(p=e[1].response.continuationContents)||void 0===p?void 0:p.gridContinuation)||void 0===f?void 0:f.continuations)||void 0===b?void 0:b[0])||void 0===y?void 0:y.nextContinuationData)||void 0===R?void 0:R.continuation)||"";for(let e=0;e<n.length;e++){let i=yield formatVideo(n[e]);if(moment(i.publishedAt).isBefore(t)&&t)return M;M.push(i)}}catch(e){D=""}return M}catch(n){getChannelVideos(e,t)}}))}function formatVideo(e,t){var n,i,o,l,d;return __awaiter(this,void 0,void 0,(function*(){try{if(e.compactVideoRenderer||e.gridVideoRenderer){let a=(e=e.compactVideoRenderer?e.compactVideoRenderer:e.gridVideoRenderer).videoId,r=0;if(e.title.simpleText?e.title=e.title.simpleText:e.title.runs[0].text?e.title=e.title.runs[0].text:e.title="",e.original_title=e.title,1===e.title.split("-").length)e.artist="";else{let t=e.original_title.match(/([^,]*)-(.*)/);e.artist=t[1],e.title=t[2]}r=e.lengthText?e.lengthText.runs[0].text.split(":"):(null===(i=null===(n=e.thumbnailOverlays[0])||void 0===n?void 0:n.thumbnailOverlayTimeStatusRenderer)||void 0===i?void 0:i.text.simpleText)?(null===(l=null===(o=e.thumbnailOverlays[0])||void 0===o?void 0:o.thumbnailOverlayTimeStatusRenderer)||void 0===l?void 0:l.text.simpleText.split(":"))||"":[0,0];let u=60*parseInt(r[0]),s=parseInt(r[1]),c=t?(null===(d=e.publishedTimeText)||void 0===d?void 0:d.runs[0].text)||"":yield getVideoDate(a);return{id:a,original_title:e.original_title.trim(),title:e.title.trim(),artist:e.artist.trim(),duration:u+s,publishedAt:c}}if(e.didYouMeanRenderer||e.showingResultsForRenderer)return{id:"didyoumean",title:(e=e.didYouMeanRenderer?e.didYouMeanRenderer:e.showingResultsForRenderer).correctedQuery.runs[0].text,artist:"",duration:0,publishedAt:""}}catch(e){}}))}module.exports={getVideoDate:getVideoDate,getChannelDesc:getChannelDesc,searchVideo:searchVideo,searchChannel:searchChannel,getChannelVideos:getChannelVideos};
