"use strict";var __awaiter=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,l){function r(e){try{a(o.next(e))}catch(e){l(e)}}function d(e){try{a(o.throw(e))}catch(e){l(e)}}function a(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,d)}a((o=o.apply(e,t||[])).next())}))};const axios_1=require("axios"),moment=require("moment"),headers={headers:{"Access-Control-Allow-Origin":"*","x-youtube-client-name":1,"x-youtube-client-version":"2.20200911.04.00","User-Agent":"Mozilla/5.0 (Linux; Android 5.0; SM-G900P Build/LRX21T) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/67.0.3396.87 Mobile Safari/537.36"}},headersAJAX={headers:{"Access-Control-Allow-Origin":"*","User-Agent":"hellobiczes","x-youtube-client-name":1,"x-youtube-client-version":"2.20200731.02.01"}},videoRegex=/ytInitialPlayerConfig\ \=\ (.*)\;\n\ \ \ \ \ \ setTimeout/,mobileRegex=/id\=\"initial\-data\"\>\<\!\-\-\ (.*)\ \-\-\>\<\/div\>\<script\ \>if/;function wait(e){for(var t=(new Date).getTime(),n=t;n<t+e;)n=(new Date).getTime()}function formatYoutubeCount(e){const t=null==e?void 0:e.includes("M"),n=null==e?void 0:e.includes("k");let o=null==e?void 0:e.replace(/[^0-9,.]/g,"").replace(",",".");return t?o*=1e6:n&&(o*=1e3),parseInt(o)||0}function getVideoDate(e){var t,n,o;return __awaiter(this,void 0,void 0,(function*(){try{const i=(yield axios_1.default.get("https://m.youtube.com/watch?v="+e,headers)).data,l=(null===(t=videoRegex.exec(i))||void 0===t?void 0:t[1])||"{}",r=JSON.parse(l);let d=null===(o=null===(n=JSON.parse(r.args.player_response).microformat)||void 0===n?void 0:n.playerMicroformatRenderer)||void 0===o?void 0:o.publishDate;return d+=" "+Math.floor(24*Math.random())+"-"+Math.floor(60*Math.random())+"-"+Math.floor(60*Math.random()),moment(d,"YYYY-MM-DD H-m-s").toDate()}catch(t){console.log("get date error for "+e+", try again",t),getVideoDate(e)}}))}function getChannelDesc(e){var t,n,o;return __awaiter(this,void 0,void 0,(function*(){try{const i=(yield axios_1.default.get("https://m.youtube.com/channel/"+encodeURI(e)+"/videos",headers)).data,l=(null===(t=mobileRegex.exec(i))||void 0===t?void 0:t[1])||"{}",r=JSON.parse(l);return(null===(o=null===(n=r.metadata)||void 0===n?void 0:n.channelMetadataRenderer)||void 0===o?void 0:o.description)||""}catch(t){console.log("channel desc error for "+e,t)}}))}function searchVideo(e,t){var n,o,i,l,r,d,a,u,s,c,v;return __awaiter(this,void 0,void 0,(function*(){try{let h=[],m=[];if(t){let e=(yield axios_1.default.get("https://youtube.com/browse_ajax?ctoken="+t,headersAJAX)).data;h=(null===(d=null===(r=e[1].response.continuationContents)||void 0===r?void 0:r.gridContinuation)||void 0===d?void 0:d.items)||"",t=(null===(v=null===(c=null===(s=null===(u=null===(a=e[1].response.continuationContents)||void 0===a?void 0:a.gridContinuation)||void 0===u?void 0:u.continuations)||void 0===s?void 0:s[0])||void 0===c?void 0:c.nextContinuationData)||void 0===v?void 0:v.continuation)||""}else{let r=(yield axios_1.default.get("https://m.youtube.com/results?sp=EgIQAQ%253D%253D&videoEmbeddable=true&search_query="+e,headers)).data,d=(null===(n=mobileRegex.exec(r))||void 0===n?void 0:n[1])||"{}",a=JSON.parse(d).contents.sectionListRenderer;h=a.contents[0].itemSectionRenderer.contents,t=(null===(l=null===(i=null===(o=a.continuations)||void 0===o?void 0:o[0])||void 0===i?void 0:i.reloadContinuationData)||void 0===l?void 0:l.continuation)||""}for(let e=0;e<h.length;e++)m.push(yield formatVideo(h[e],!0));return{tracks:m,token:t}}catch(t){console.log("search videos error, terms: "+e,t)}}))}function searchChannel(e,t){var n,o,i,l,r,d,a,u,s,c,v,h,m,f,g,p,x,b;return __awaiter(this,void 0,void 0,(function*(){try{let y=[],_=[];if(t){let e=(yield axios_1.default.get("https://youtube.com/browse_ajax?ctoken="+t,headersAJAX)).data;y=(null===(s=null===(u=e[1].response.continuationContents)||void 0===u?void 0:u.gridContinuation)||void 0===s?void 0:s.items)||"",t=(null===(f=null===(m=null===(h=null===(v=null===(c=e[1].response.continuationContents)||void 0===c?void 0:c.gridContinuation)||void 0===v?void 0:v.continuations)||void 0===h?void 0:h[0])||void 0===m?void 0:m.nextContinuationData)||void 0===f?void 0:f.continuation)||""}else{const u=(yield axios_1.default.get("https://m.youtube.com/results?sp=CAASAhAC&search_query="+encodeURI(e),headers)).data,s=(null===(n=mobileRegex.exec(u))||void 0===n?void 0:n[1])||"{}",c=JSON.parse(s);y=null===(l=null===(i=null===(o=c.contents.sectionListRenderer)||void 0===o?void 0:o.contents[0])||void 0===i?void 0:i.itemSectionRenderer)||void 0===l?void 0:l.contents,t=(null===(a=null===(d=null===(r=c.continuations)||void 0===r?void 0:r[0])||void 0===d?void 0:d.reloadContinuationData)||void 0===a?void 0:a.continuation)||""}for(let e=0;e<y.length;e++)if(y[e].compactChannelRenderer){const t=y[e].compactChannelRenderer;let n=(null===(g=t.thumbnail)||void 0===g?void 0:g.thumbnails[0].url)||"",o=(null===(p=t.thumbnail)||void 0===p?void 0:p.thumbnails[1].url)||"";n=n.startsWith("//")?"https:"+n:n,o=o.startsWith("//")?"https:"+o:o;const i=formatYoutubeCount(null===(x=t.subscriberCountText)||void 0===x?void 0:x.runs[0].text),l=formatYoutubeCount(null===(b=t.videoCountText)||void 0===b?void 0:b.runs[0].text);_.push({name:t.title.runs[0].text,channel_id:t.channelId,nb_videos:l,nb_subscriber:i,official:!!t.ownerBadges,channel_avatar_small:n,channel_avatar_medium:o})}else if(y[e].didYouMeanRenderer||y[e].showingResultsForRenderer){let t;t=y[e].didYouMeanRenderer?y[e].didYouMeanRenderer:y[e].showingResultsForRenderer,_.push({name:t.correctedQuery.runs[0].text,channel_id:"didyoumean",nb_videos:"0",nb_subscriber:"0",official:!1,channel_avatar_small:"",channel_avatar_medium:""}),_[e]}return{channels:_,token:t}}catch(t){console.log("search channel error, terms: "+e,t)}}))}function getChannelVideos(e,t){var n,o,i,l,r,d,a,u,s,c,v,h,m,f,g,p,x,b,y;return __awaiter(this,void 0,void 0,(function*(){try{const _=(yield axios_1.default.get("https://m.youtube.com/channel/"+encodeURI(e)+"/videos",headers)).data,R=(null===(n=mobileRegex.exec(_))||void 0===n?void 0:n[1])||"{}",C=JSON.parse(R),w=null===(a=null===(d=null===(r=null===(l=null===(i=null===(o=C.contents.singleColumnBrowseResultsRenderer)||void 0===o?void 0:o.tabs[1])||void 0===i?void 0:i.tabRenderer)||void 0===l?void 0:l.content)||void 0===r?void 0:r.sectionListRenderer)||void 0===d?void 0:d.contents[0])||void 0===a?void 0:a.itemSectionRenderer;let A=(null===(c=null===(s=null===(u=w.continuations)||void 0===u?void 0:u[0])||void 0===s?void 0:s.nextContinuationData)||void 0===c?void 0:c.continuation)||"",M=[];for(let e=0;e<w.contents.length;e++){let n=yield formatVideo(w.contents[e]);if(t){if(!moment(n.publishedAt).isAfter(t)||!t)return M;M.push(n)}else M.push(n)}for(;""!==A;)try{wait(Math.floor(300*Math.random()));let e=(yield axios_1.default.get("https://youtube.com/browse_ajax?ctoken="+A,headersAJAX)).data,n=(null===(f=null===(m=null===(h=null===(v=e[1])||void 0===v?void 0:v.response)||void 0===h?void 0:h.continuationContents)||void 0===m?void 0:m.gridContinuation)||void 0===f?void 0:f.items)||"";A=(null===(y=null===(b=null===(x=null===(p=null===(g=e[1].response.continuationContents)||void 0===g?void 0:g.gridContinuation)||void 0===p?void 0:p.continuations)||void 0===x?void 0:x[0])||void 0===b?void 0:b.nextContinuationData)||void 0===y?void 0:y.continuation)||"";for(let e=0;e<n.length;e++){let o=yield formatVideo(n[e]);if(moment(o.publishedAt).isBefore(t)&&t)return M;M.push(o)}}catch(e){console.log(e),A=""}return M}catch(t){console.log("channel videos error for id: "+e,t)}}))}function formatVideo(e,t){var n,o,i,l,r;return __awaiter(this,void 0,void 0,(function*(){try{if(e.compactVideoRenderer||e.gridVideoRenderer){let d=(e=e.compactVideoRenderer?e.compactVideoRenderer:e.gridVideoRenderer).videoId,a=0;if(e.title.simpleText?e.title=e.title.simpleText:e.title.runs[0].text?e.title=e.title.runs[0].text:e.title="",e.original_title=e.title,1===e.title.split("-").length)e.artist="";else{let t=e.original_title.match(/([^,]*)-(.*)/);e.artist=t[1],e.title=t[2]}a=e.lengthText?e.lengthText.runs[0].text.split(":"):(null===(o=null===(n=e.thumbnailOverlays[0])||void 0===n?void 0:n.thumbnailOverlayTimeStatusRenderer)||void 0===o?void 0:o.text.simpleText)?(null===(l=null===(i=e.thumbnailOverlays[0])||void 0===i?void 0:i.thumbnailOverlayTimeStatusRenderer)||void 0===l?void 0:l.text.simpleText.split(":"))||"":[0,0];let u=60*parseInt(a[0]),s=parseInt(a[1]),c=t?(null===(r=e.publishedTimeText)||void 0===r?void 0:r.runs[0].text)||"":yield getVideoDate(d);return{id:d,original_title:e.original_title.trim(),title:e.title.trim(),artist:e.artist.trim(),duration:u+s,publishedAt:c}}if(e.didYouMeanRenderer||e.showingResultsForRenderer)return{id:"didyoumean",title:(e=e.didYouMeanRenderer?e.didYouMeanRenderer:e.showingResultsForRenderer).correctedQuery.runs[0].text,artist:"",duration:0,publishedAt:""}}catch(e){console.log(e)}}))}module.exports={getVideoDate:getVideoDate,getChannelDesc:getChannelDesc,searchVideo:searchVideo,searchChannel:searchChannel,getChannelVideos:getChannelVideos};
